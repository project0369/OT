<!DOCTYPE html>
<html>
<head>
    <title>ระบบคำนวณ OT</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        .ot-highlight {
            background-color: #c8e6c9; /* สีเขียวอ่อน */
        }
        .holiday-section {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>ระบบคำนวณ OT</h1>

    <!-- ส่วนเพิ่มวันหยุดพิเศษ -->
    <div class="holiday-section">
        <h2>เพิ่มวันหยุดพิเศษ</h2>
        <input type="date" id="holidayDate">
        <button onclick="addHoliday()">เพิ่มวันหยุด</button>
        <ul id="holidayList"></ul>
    </div>

    <!-- ปุ่มคำนวณ OT -->
    <button onclick="calculateAndDisplayOT()">คำนวณ OT</button>

    <!-- ตารางแสดงผล OT -->
    <table id="otTable">
        <thead>
            <tr>
                <th>ชื่อ-สกุล</th>
                <th>วันที่</th>
                <th>เวลาเข้างาน</th>
                <th>เวลาออกงาน</th>
                <th>วัน</th>
                <th>OT (ชั่วโมง)</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <script>
        const googleSheetApiUrl = 'https://script.google.com/macros/s/AKfycbzmOUpibFnh9Cwhd_EtG3HnOWFC84cT0JzpqxSf7YTgywlb0Cv9T_niL_wtn37gvrQxNQ/exec';
        let holidays = []; // เก็บรายการวันหยุดพิเศษ

        // เพิ่มวันหยุดพิเศษ
        function addHoliday() {
            const holidayDate = document.getElementById('holidayDate').value;
            if (holidayDate && !holidays.includes(holidayDate)) {
                holidays.push(holidayDate);
                updateHolidayList();
            }
        }

        // อัปเดตรายการวันหยุดในหน้าเว็บ
        function updateHolidayList() {
            const holidayList = document.getElementById('holidayList');
            holidayList.innerHTML = holidays.map(date => `<li>${date}</li>`).join('');
        }

        // คำนวณและแสดงผล OT
        function calculateAndDisplayOT() {
            fetch(googleSheetApiUrl)
                .then(response => response.json())
                .then(data => {
                    console.log('Data from Google Sheets:', data); // ตรวจสอบข้อมูลที่ได้
                    const parsedData = parseData(data); // แปลงข้อมูล
                    const otData = calculateOT(parsedData); // คำนวณ OT
                    displayResults(otData); // แสดงผล
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        }

        // แปลงข้อมูลจาก Array ของ Array เป็น Array ของ Object
        function parseData(data) {
            const result = [];
            const headers = data[0]; // แถวแรกคือหัวข้อคอลัมน์

            for (let i = 1; i < data.length; i++) {
                const obj = {};
                const currentLine = data[i];

                for (let j = 0; j < headers.length; j++) {
                    obj[headers[j].trim()] = currentLine[j] ? currentLine[j].trim() : '';
                }
                result.push(obj);
            }
            return result;
        }

        // คำนวณ OT
        function calculateOT(data) {
            const otData = [];
            const employeeData = {};

            data.forEach(row => {
                const name = row['ชื่อ-สกุล'];
                const dateTime = row['วันที่-เวลา'];

                // ตรวจสอบว่ามีข้อมูลหรือไม่
                if (!name || !dateTime) {
                    console.warn('Missing data in row:', row);
                    return; // ข้ามแถวนี้
                }

                // แปลงรูปแบบ ISO 8601 เป็น "ปี-เดือน-วัน ชั่วโมง:นาที:วินาที"
                const isoDate = new Date(dateTime);
                if (isNaN(isoDate.getTime())) {
                    console.warn('Invalid date-time format in row:', row);
                    return; // ข้ามแถวนี้
                }

                const date = isoDate.toISOString().split('T')[0]; // ได้รูปแบบ "ปี-เดือน-วัน"
                const time = isoDate.toTimeString().split(' ')[0]; // ได้รูปแบบ "ชั่วโมง:นาที:วินาที"

                if (!employeeData[name]) {
                    employeeData[name] = {};
                }

                if (!employeeData[name][date]) {
                    employeeData[name][date] = {};
                }

                // กำหนดเวลาเข้างานและเวลาออกงาน
                if (!employeeData[name][date].in) {
                    employeeData[name][date].in = time;
                } else {
                    employeeData[name][date].out = time;
                }
            });

            // คำนวณ OT สำหรับแต่ละคนและแต่ละวัน
            for (const name in employeeData) {
                for (const date in employeeData[name]) {
                    const inTime = employeeData[name][date].in;
                    const outTime = employeeData[name][date].out;
                    const day = new Date(date).toLocaleDateString('th-TH', { weekday: 'long' });
                    let otHours = 0;

                    if (inTime && outTime) {
                        otHours = calculateOtHours(date, inTime, outTime);
                    } else {
                        otHours = 0; // ถ้าไม่มีข้อมูลครบ ให้ถือว่าไม่ได้ทำ OT
                    }

                    otData.push({ name, date, timeIn: inTime || '-', timeOut: outTime || '-', day, otHours });
                }
            }
            return otData;
        }

        // คำนวณชั่วโมง OT
        function calculateOtHours(date, timeIn, timeOut) {
            const day = new Date(date).getDay();
            const [inHour, inMinute] = timeIn.split(':').map(Number);
            const [outHour, outMinute] = timeOut.split(':').map(Number);

            // ตรวจสอบว่าเวลาเข้างานและเวลาออกงานถูกต้อง
            if (isNaN(inHour) || isNaN(inMinute) || isNaN(outHour) || isNaN(outMinute)) {
                console.warn('Invalid time format:', { timeIn, timeOut });
                return 0;
            }

            const inTimeDecimal = inHour + inMinute / 60;
            const outTimeDecimal = outHour + outMinute / 60;
            let otHours = 0;

            // ตรวจสอบว่าเป็นวันหยุดพิเศษหรือไม่
            const isHoliday = holidays.includes(date);

            if (isHoliday || day === 6 || day === 0) { // วันหยุดพิเศษ, วันเสาร์, วันอาทิตย์
                otHours = outTimeDecimal - inTimeDecimal;
            } else if (day >= 1 && day <= 5) { // วันจันทร์ - ศุกร์
                if (outTimeDecimal > 16.5) {
                    otHours = outTimeDecimal - 16.5;
                }
            }
            return otHours.toFixed(2);
        }

        // แสดงผลลัพธ์ในตาราง
        function displayResults(otData) {
            const tableBody = document.querySelector('#otTable tbody');
            tableBody.innerHTML = '';

            otData.forEach(item => {
                const row = document.createElement('tr');
                const otCell = `<td class="${item.otHours >= 2 ? 'ot-highlight' : ''}">${item.otHours}</td>`;

                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.date}</td>
                    <td>${item.timeIn}</td>
                    <td>${item.timeOut}</td>
                    <td>${item.day}</td>
                    ${otCell}
                `;
                tableBody.appendChild(row);
            });
        }
    </script>
</body>
</html>
